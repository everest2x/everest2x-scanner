<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Everest2X Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      margin: 0;
      font-family: Segoe UI, Arial, sans-serif;
      background: #111;
      color: white;
      text-align: center;
    }
    .wrap {
      max-width: 460px;
      margin: 0 auto;
      padding: 12px;
    }
    h2 {
      margin: 8px 0 10px;
      font-size: 22px;
    }
    #reader {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      margin: 10px 0;
    }
    .btn {
      width: 100%;
      border: none;
      border-radius: 10px;
      padding: 14px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      margin-top: 8px;
      font-size: 15px;
    }
    .btn-start { background: #1a73e8; }
    .btn-stop { background: #d93025; }
    #msg {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      white-space: pre-wrap;
    }
    .warn { background: #fbbc04; color: #111; }
    .ok   { background: #34a853; color: white; }
    .err  { background: #d93025; color: white; }
    .hidden { display: none !important; }
    .small {
      font-size: 12px;
      color: #ccc;
      margin-top: 8px;
      line-height: 1.35;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Everest2X scanner</h2>

    <div id="reader"></div>

    <button id="startBtn" class="btn btn-start">Kamera ind√≠t√°sa</button>
    <button id="stopBtn" class="btn btn-stop hidden">Scannel√©s megszak√≠t√°sa</button>
    
    <div id="msg" class="warn">Scanner el≈ëk√©sz√≠t√©se...</div>
    <div class="small">
      A sikeres beolvas√°s ut√°n a k√≥d visszaker√ºl az Everest2X f≈ëoldalra.
    </div>
  </div>

  <script>
    let qrScanner = null;
    let isRunning = false;
    // Ne k√ºldj√ºnk ugyanarr√≥l az esem√©nyr≈ël t√∂bb postMessage-et
    let closeSignalSent = false;
    let autoStartTried = false;
    let scanHintTimer = null;
    
    function postToOpener(payload) {
      try {
        if (window.opener && !window.opener.closed) {
          window.opener.postMessage(
            Object.assign({ source: "everest2x-scanner" }, payload),
            "*"
          );
        }
      } catch (e) {
        console.warn("postMessage hiba:", e);
      }
    }

    function setMsg(text, cls) {
      const m = document.getElementById("msg");
      m.className = cls || "warn";
      m.innerText = text;
    }

    function refreshCloseButtonLabel() {
      const stopBtn = document.getElementById("stopBtn");
      if (!stopBtn) return;

      stopBtn.innerText = isRunning ? "Scannel√©s megszak√≠t√°sa" : "Bez√°r√°s";
    }
    
  function clearScanHintTimer() {
    if (scanHintTimer) {
      clearTimeout(scanHintTimer);
      scanHintTimer = null;
    }
  }  

  refreshCloseButtonLabel();
    
  function checkOpenedFromApp() {
  const hasOpener = !!(window.opener && !window.opener.closed);

  if (!hasOpener) {
    setMsg(
      "‚ÑπÔ∏è Ez a scanner √∂n√°ll√≥an lett megnyitva.\nAz Everest2X alkalmaz√°sb√≥l ind√≠tsd a beolvas√°st.",
      "err"
    );

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    if (startBtn) {
      startBtn.disabled = true;
      startBtn.style.opacity = "0.6";
      startBtn.style.cursor = "not-allowed";
      startBtn.innerText = "Kamera ind√≠t√°sa (csak az alkalmaz√°sb√≥l)";
    }

    if (stopBtn) {
      stopBtn.classList.add("hidden");
    }

    return false;
  }

  return true;
}
    
   async function startScanner() {
  if (!checkOpenedFromApp()) return;
  if (isRunning) return;

  const startBtnEl = document.getElementById("startBtn");
  const stopBtnEl = document.getElementById("stopBtn");

  // Norm√°l alapfelirat (ne ragadjon "√öjrapr√≥b√°l√°s"-on)
  if (startBtnEl) {
    startBtnEl.innerText = "Kamera ind√≠t√°sa";
  }

  if (startBtnEl) startBtnEl.classList.add("hidden");
  if (stopBtnEl) stopBtnEl.classList.remove("hidden");

  setMsg("üì∑ Kamera keres√©se...", "warn");

  try {
    // biztos takar√≠t√°s
    if (qrScanner) {
      try { await qrScanner.stop(); } catch (e) {}
      try { qrScanner.clear(); } catch (e) {}
      qrScanner = null;
    }

    const cameras = await Html5Qrcode.getCameras();
    if (!cameras || cameras.length === 0) {
      throw new Error("Nincs el√©rhet≈ë kamera.");
    }

    let cam = cameras.find(c => /back|rear|environment/i.test(c.label || ""))
           || cameras[cameras.length - 1];

    setMsg("üì∑ Kamera ind√≠t√°sa...", "warn");

    qrScanner = new Html5Qrcode("reader");
    isRunning = true;
    refreshCloseButtonLabel();
    
    await qrScanner.start(
      { deviceId: { exact: cam.id } },
      { fps: 10, qrbox: 250 },
      async (decodedText) => {
        if (!isRunning) return;
        isRunning = false;
        clearScanHintTimer();
        refreshCloseButtonLabel();

        setMsg("‚úÖ QR beolvasva, k√ºld√©s a f≈ëoldalra...", "ok");

        // Gombok elrejt√©se (vizu√°lis finom√≠t√°s)
        document.getElementById("stopBtn")?.classList.add("hidden");
        document.getElementById("startBtn")?.classList.add("hidden");

        // EL≈êSZ√ñR k√ºldj√ºk vissza a f≈ëoldalnak (ne akadjon meg a stop miatt)
        postCloseSignalOnce({ type: "SCAN_SUCCESS", qrText: decodedText });

        // Ut√°na takar√≠tsunk √©s z√°rjunk
        setTimeout(async () => {
          try { if (qrScanner) await qrScanner.stop(); } catch (e) {}
          try { if (qrScanner) qrScanner.clear(); } catch (e) {}
          qrScanner = null;

          try { window.close(); } catch (e) {}
        }, 50);
      }
    );

    setMsg("üì∑ Ir√°ny√≠tsd a kamer√°t a QR k√≥dra...", "warn");

    clearScanHintTimer();
    scanHintTimer = setTimeout(() => {
      // csak akkor √≠rjunk ki √ºzenetet, ha m√©g mindig fut a scanner
      if (isRunning) {
        setMsg(
          "‚è≥ M√©g nincs beolvas√°s.\nIr√°ny√≠tsd a kamer√°t a QR k√≥dra, vagy nyomj megszak√≠t√°st √©s pr√≥b√°ld √∫jra.",
          "warn"
        );
      }
    }, 90000); // 90 mp

  } catch (err) {
    isRunning = false;
    clearScanHintTimer();
    refreshCloseButtonLabel();

    const code = err && err.name ? err.name : "";
    const text = err && err.message ? err.message : String(err);

    let hint = "";
    if (code === "NotAllowedError") hint = " (Kamera enged√©ly tiltva.)";
    else if (code === "NotReadableError") hint = " (A kamera foglalt.)";
    else if (code === "OverconstrainedError") hint = " (Nem el√©rhet≈ë kamera m√≥d.)";

    setMsg(`‚ùå Kamera hiba${hint}\n${code ? code + ": " : ""}${text}`, "err");
    // Nem k√ºld√ºnk azonnal SCAN_ERROR-t a f≈ëoldalnak,
    // mert a felhaszn√°l√≥ m√©g tud "√öjrapr√≥b√°l√°s"-t nyomni a popupban.

    const startBtnRetry = document.getElementById("startBtn");
    const stopBtnRetry = document.getElementById("stopBtn");

    if (startBtnRetry) {
      startBtnRetry.classList.remove("hidden");
      startBtnRetry.disabled = false;
      startBtnRetry.style.opacity = "1";
      startBtnRetry.style.cursor = "pointer";
      startBtnRetry.innerText = "√öjrapr√≥b√°l√°s";
    }

    if (stopBtnRetry) {
      stopBtnRetry.classList.add("hidden");
    }
  }
}

    function postCloseSignalOnce(payload) {
      if (closeSignalSent) return false;
      closeSignalSent = true;
      postToOpener(payload);
      return true;
    }

    async function stopScanner() {
      isRunning = false;
      clearScanHintTimer();
      refreshCloseButtonLabel();

      try {
        if (qrScanner) {
          try { await qrScanner.stop(); } catch(e) {}
          try { qrScanner.clear(); } catch(e) {}
          qrScanner = null;
        }
      } catch(e) {}

      postCloseSignalOnce({ type: "SCAN_CANCELLED" });

      setTimeout(() => window.close(), 150);
    }

    document.getElementById("startBtn").addEventListener("click", startScanner);
    document.getElementById("stopBtn").addEventListener("click", stopScanner);

    // Ha a user X-szel z√°rja be, pr√≥b√°ljunk jelezni
    window.addEventListener("beforeunload", () => {
      postCloseSignalOnce({ type: "SCAN_CANCELLED" });
    });

    const openedFromApp = checkOpenedFromApp();

    if (openedFromApp) {
      setTimeout(() => {
        if (!autoStartTried && !isRunning) {
          autoStartTried = true;
          startScanner();
        }
      }, 150);
    }
  </script>
</body>
</html>
